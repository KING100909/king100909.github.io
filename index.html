<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√≤ng Chat ƒêa Ph∆∞∆°ng Ti·ªán Pro</title>
    <style>
        :root { --primary: #4f46e5; --bg: #f1f5f9; --record: #ef4444; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); display: flex; justify-content: center; height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 500px; background: white; display: flex; flex-direction: column; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        h2 { background: var(--primary); color: white; margin: 0; padding: 20px; text-align: center; font-size: 1.2rem; }
        
        #chatDisplay { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #ffffff; }
        
        .message-box { background: #f8fafc; padding: 12px 18px; border-radius: 18px; border: 1px solid #e2e8f0; position: relative; animation: fadeIn 0.2s ease; max-width: 80%; align-self: flex-start; }
        .user-name { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; text-transform: uppercase; }
        
        /* Style cho Audio v√† ·∫¢nh */
        .sent-image { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        audio { max-width: 100%; height: 35px; margin-top: 5px; }

        .btn-delete { position: absolute; top: 5px; right: -25px; color: #cbd5e1; cursor: pointer; border: none; background: none; font-size: 18px; }

        .input-area { padding: 20px; border-top: 1px solid #e2e8f0; background: white; }
        .row { display: flex; gap: 8px; margin-bottom: 10px; }
        input { padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; outline: none; }
        #userName { width: 70px; font-weight: bold; }
        #noteInput { flex: 1; }
        
        .action-buttons { display: flex; gap: 8px; }
        .btn-send { flex: 1; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        
        .btn-icon { background: #e2e8f0; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        
        /* Hi·ªáu ·ª©ng khi ƒëang ghi √¢m */
        .recording { background: var(--record) !important; color: white !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h2>Ph√≤ng Chat ƒêa Ph∆∞∆°ng Ti·ªán üéôÔ∏èüì∏</h2>
    <div id="chatDisplay"></div>
    <div class="input-area">
        <div class="row">
            <input type="text" id="userName" placeholder="T√™n...">
            <input type="text" id="noteInput" placeholder="Nh·∫≠p tin nh·∫Øn...">
        </div>
        <div class="action-buttons">
            <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="App.handleImage(this)">
            <button class="btn-icon" onclick="document.getElementById('fileInput').click()">üì∑</button>
            
            <button id="recordBtn" class="btn-icon" onclick="App.toggleRecording()">üé§</button>
            
            <button class="btn-send" onclick="App.sendMessage()">G·ª¨I</button>
        </div>
    </div>
</div>

<script>
    const App = (() => {
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        const state = new Proxy({
            messages: JSON.parse(localStorage.getItem('my_chat_ultimate')) || []
        }, {
            set(target, property, value) {
                target[property] = value;
                try {
                    localStorage.setItem('my_chat_ultimate', JSON.stringify(value));
                } catch(e) { alert("B·ªô nh·ªõ tr√¨nh duy·ªát ƒë√£ ƒë·∫ßy!"); }
                render();
                return true;
            }
        });

        function render() {
            const display = document.getElementById('chatDisplay');
            display.innerHTML = state.messages.map((msg, index) => `
                <div class="message-box">
                    <button class="btn-delete" onclick="App.deleteMessage(${index})">√ó</button>
                    <span class="user-name" style="color: #4f46e5">${msg.user}</span>
                    ${renderContent(msg)}
                </div>
            `).join('');
            display.scrollTop = display.scrollHeight;
        }

        function renderContent(msg) {
            if (msg.type === 'image') return `<img src="${msg.content}" class="sent-image">`;
            if (msg.type === 'voice') return `<audio controls src="${msg.content}"></audio>`;
            return `<div class="message-text">${msg.content}</div>`;
        }

        return {
            sendMessage() {
                const textInp = document.getElementById('noteInput');
                const user = document.getElementById('userName').value || "·∫®n danh";
                if (!textInp.value.trim()) return;
                state.messages = [...state.messages, { user, content: textInp.value, type: 'text' }];
                textInp.value = '';
            },

            async toggleRecording() {
                const btn = document.getElementById('recordBtn');
                if (!isRecording) {
                    // B·∫Øt ƒë·∫ßu ghi √¢m
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => {
                            const user = document.getElementById('userName').value || "·∫®n danh";
                            state.messages = [...state.messages, { user, content: reader.result, type: 'voice' }];
                        };
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    btn.innerText = "‚èπÔ∏è";
                } else {
                    // D·ª´ng v√† g·ª≠i
                    mediaRecorder.stop();
                    isRecording = false;
                    btn.classList.remove('recording');
                    btn.innerText = "üé§";
                }
            },

            handleImage(input) {
                const reader = new FileReader();
                reader.onload = e => {
                    const user = document.getElementById('userName').value || "·∫®n danh";
                    state.messages = [...state.messages, { user, content: e.target.result, type: 'image' }];
                };
                reader.readAsDataURL(input.files[0]);
            },

            deleteMessage(index) {
                if(confirm("X√≥a m·ª•c n√†y?")) {
                    const newMsgs = [...state.messages];
                    newMsgs.splice(index, 1);
                    state.messages = newMsgs;
                }
            }
        };
    })();
    
    window.onload = () => {
        const savedName = localStorage.getItem('chat_user_name');
        if (savedName) document.getElementById('userName').value = savedName;
        // C·∫ßn g·ªçi render l·∫ßn ƒë·∫ßu
        const display = document.getElementById('chatDisplay');
        display.innerHTML = (JSON.parse(localStorage.getItem('my_chat_ultimate')) || []).map((msg, index) => `
                <div class="message-box">
                    <button class="btn-delete" onclick="App.deleteMessage(${index})">√ó</button>
                    <span class="user-name" style="color: #4f46e5">${msg.user}</span>
                    ${msg.type === 'image' ? `<img src="${msg.content}" class="sent-image">` : 
                      msg.type === 'voice' ? `<audio controls src="${msg.content}"></audio>` : 
                      `<div class="message-text">${msg.content}</div>`}
                </div>
            `).join('');
    };
</script>
</body>
</html>
