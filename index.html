<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger Pro Max - Full Features</title>
    <style>
        :root {
            --primary: #0084ff;
            --bg: #f0f2f5;<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger Pro Max V2 - Easter Egg</title>
    <style>
        :root {
            --primary: #0084ff;
            --bg: #f0f2f5;
            --msg-me: #0084ff;
            --msg-them: rgba(255, 255, 255, 0.9);
        }

        html, body {
            height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: var(--bg);
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        .hidden { display: none !important; }

        .chat-app {
            display: flex; flex-direction: column;
            height: 100dvh; max-width: 600px;
            margin: 0 auto; background: white;
            position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        header {
            padding: 12px 15px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            background: white; z-index: 10;
        }

        #chatDisplay {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 15px;
            background-color: white;
            background-size: cover; 
            background-position: center;
            background-attachment: fixed;
            transition: background 0.3s ease;
            box-shadow: inset 0 0 0 2000px rgba(0,0,0,0.05); 
        }

        .msg-row { display: flex; flex-direction: column; width: 100%; position: relative; }
        .me { align-items: flex-end; }
        .them { align-items: flex-start; }

        .bubble-container { position: relative; max-width: 75%; display: flex; flex-direction: column; }
        .me .bubble-container { align-items: flex-end; }

        .bubble {
            padding: 10px 15px; border-radius: 18px;
            font-size: 15px; line-height: 1.4;
            word-wrap: break-word; white-space: pre-wrap;
            text-align: left; cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
        }
        .bubble:active { transform: scale(0.98); }
        .me .bubble { background: linear-gradient(135deg, #0084ff 0%, #00c6ff 100%); color: white; border-bottom-right-radius: 4px; }
        .them .bubble { background: rgba(255, 255, 255, 0.85); color: black; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.3); }

        .sender-name {
            font-size: 11px; color: #fff; margin-bottom: 2px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.9); font-weight: bold;
        }

        /* HI·ªÜU ·ª®NG CH·ªÆ CH·∫†Y LUNG TUNG */
        .guessed-text {
            position: fixed; z-index: 9999;
            font-weight: bold; font-size: 20px;
            pointer-events: none; white-space: nowrap;
            animation: moveAround 3s linear forwards;
        }

        @keyframes moveAround {
            0% { transform: translate(0,0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            25% { transform: translate(30vw, 20vh) rotate(90deg); }
            50% { transform: translate(-20vw, 50vh) rotate(180deg); }
            75% { transform: translate(10vw, -10vh) rotate(270deg); }
            100% { transform: translate(0, 0) rotate(360deg); opacity: 0; }
        }

        /* C√ÅC PH·∫¶N C√íN L·∫†I GI·ªÆ NGUY√äN */
        .reaction-bar { display: none; position: absolute; top: -50px; background: white; border-radius: 25px; padding: 5px 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 100; gap: 8px; align-items: center; }
        .bottom-sheet { position: absolute; bottom: 0; left: 0; right: 0; background: white; z-index: 2000; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.15); padding: 20px; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s; }
        .bottom-sheet.open { transform: translateY(0); }
        .theme-scroll { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; overflow-y: auto; height: 50vh; }
        .theme-item { height: 140px; border-radius: 12px; cursor: pointer; display: flex; align-items: flex-end; justify-content: center; padding: 10px; background-size: cover; background-position: center; border: 1px solid #eee; }
        .bottom-bar { padding: 8px 12px; border-top: 1px solid #eee; display: flex; align-items: flex-end; gap: 8px; background: white; }
        #msgTextarea { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #eee; background: #f0f2f5; outline: none; font-size: 15px; max-height: 100px; resize: none; }
        .action-btn { border: none; background: none; cursor: pointer; padding: 6px; }
        .emoji-badge { position: absolute; bottom: -12px; right: 10px; background: white; border-radius: 12px; padding: 2px 6px; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #eee; }
        .settings-modal { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 1500; padding: 20px; display: flex; flex-direction: column; }
      /* Hi·ªáu ·ª©ng ch·ªØ ch·∫°y ngang m√†n h√¨nh trong 10s */
.guessed-text {
    position: fixed;
    z-index: 9999;
    font-weight: bold;
    font-size: 24px;
    color: #ff0055;
    white-space: nowrap;
    pointer-events: none;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.2);
    /* Ch·∫°y t·ª´ ph·∫£i sang tr√°i */
    animation: marquee-horizontal 10s linear forwards;
}

@keyframes marquee-horizontal {
    0% { 
        right: -100%; /* B·∫Øt ƒë·∫ßu ngo√†i m√†n h√¨nh b√™n ph·∫£i */
        opacity: 0;
    }
    5% { 
        opacity: 1; 
    }
    95% {
        opacity: 1;
    }
    100% { 
        right: 110%; /* K·∫øt th√∫c ngo√†i m√†n h√¨nh b√™n tr√°i */
        opacity: 0;
    }
}
/* --- V·ªä TR√ç 1: TR∆Ø·ªöC TH·∫∫ ƒê√ìNG STYLE --- */
.guessed-text {
    position: fixed;
    left: 0;
    z-index: 9999;
    font-weight: bold;
    font-size: 26px;
    white-space: nowrap;
    pointer-events: none;
    text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
    animation: marquee-x 10s linear forwards;
}

@keyframes marquee-x {
    0% { transform: translateX(100vw); opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { transform: translateX(-100%); opacity: 0; }
}
    </style>
</head>
<body>

    <div id="screenRegister" class="hidden" style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h2 style="color: var(--primary);">Messenger</h2>
        <input type="text" id="usernameInp" placeholder="T√™n c·ªßa b·∫°n..." style="padding:15px; border-radius:10px; border:1px solid #ddd; margin-bottom:10px; width:250px;">
        <button onclick="register()" style="padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; width:250px; font-weight:bold;">V√†o Chat</button>
    </div>

    <div id="screenChat" class="chat-app hidden">
        <header>
            <div><strong id="headerUsername">...</strong></div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <button onclick="toggleThemePanel()" class="action-btn" style="font-size: 22px;">üé®</button>
                <button onclick="toggleSettings()" class="action-btn" style="font-size: 22px;">‚öôÔ∏è</button>
                <button onclick="logout()" style="border:none; background:none; color:red; font-weight:bold;">Tho√°t</button>
            </div>
        </header>

        <div id="settingsPanel" class="settings-modal hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Ch·ªçn Emoji nhanh</h3>
                <button onclick="toggleSettings()" style="border:none; background:none; font-size: 35px;">&times;</button>
            </div>
            <div class="emoji-grid-settings" id="emojiSelection"></div>
        </div>

        <div id="chatDisplay" onclick="closeAllPopups()"></div>

        <div id="themePanel" class="bottom-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <strong>Ch·ªß ƒë·ªÅ chi ti·∫øt</strong>
                <button onclick="toggleThemePanel()" style="border:none; background:none; font-size:28px;">&times;</button>
            </div>
            <div class="theme-scroll" id="themeList"></div>
        </div>

        <div class="bottom-bar">
            <button class="action-btn" onclick="document.getElementById('mediaInp').click()">üì∑</button>
            <input type="file" id="mediaInp" hidden onchange="sendMedia(this)">
            <button id="micBtn" class="action-btn" onclick="toggleVoice()">üé§</button>
            <textarea id="msgTextarea" rows="1" placeholder="Aa" oninput="autoResize(this)" onkeydown="handleKeyDown(event)"></textarea>
            <button id="quickEmojiBtn" class="action-btn" style="font-size: 24px;" onclick="sendQuickEmoji()">üíô</button>
            <button class="action-btn" onclick="sendText()">üöÄ</button>
        </div>
    </div>

<script>
    let account = JSON.parse(localStorage.getItem('off_acc')) || null;
    let database = JSON.parse(localStorage.getItem('off_db')) || [];
    let quickEmoji = localStorage.getItem('off_emoji') || 'üíô';
    let currentTheme = localStorage.getItem('off_theme') || 'white';
    let mediaRec; let chunks = [];

    const quickReacts = ['‚ù§Ô∏è','üòÜ','üòÆ','üò¢','üò†','üëç'];
    const settingsEmojis = ['üíô','üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üò†','üî•','üíØ','üéâ','‚ú®','üöÄ'];
    const chatThemes = [
        { name: 'M·∫∑c ƒë·ªãnh', bg: 'white' },
        { name: 'S·ª£i Carbon', bg: 'url("https://www.transparenttextures.com/patterns/carbon-fibre.png"), #222' },
        { name: 'Th√†nh ph·ªë ƒë√™m', bg: 'url("https://images.unsplash.com/photo-1514565131-fce0801e5785?w=600&q=80")' }
    ];

    function render() {
        if (!account) {
            document.getElementById('screenRegister').classList.remove('hidden');
            document.getElementById('screenChat').classList.add('hidden');
            return;
        }
        document.getElementById('screenRegister').classList.add('hidden');
        document.getElementById('screenChat').classList.remove('hidden');
        document.getElementById('headerUsername').innerText = account.name;
        document.getElementById('quickEmojiBtn').innerText = quickEmoji;
        applyTheme();

        const display = document.getElementById('chatDisplay');
        display.innerHTML = database.map((m, index) => {
            const isMe = m.uid === account.uid;
            let content = m.content;
            if (m.type === 'image') content = `<img src="${m.content}" class="media-content">`;
            else if (m.type === 'voice') content = `<audio src="${m.content}" controls></audio>`;

            return `
                <div class="msg-row ${isMe ? 'me' : 'them'}">
                    <span class="sender-name">${m.uName}</span>
                    <div class="bubble-container">
                        <div class="bubble" onclick="showReactions(event, ${index})">${content}</div>
                        ${m.reaction ? `<div class="emoji-badge">${m.reaction}</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        display.scrollTop = display.scrollHeight;
    }

    // --- LOGIC HI·ªÜU ·ª®NG ƒêO√ÅN ƒê√öNG ---
    function triggerSuccessEffect() {
        const colors = ['#0084ff', '#ff0055', '#28a745', '#ffc107', '#6f42c1'];
        for(let i = 0; i < 8; i++) {
            const el = document.createElement('div');
            el.className = 'guessed-text';
            el.innerText = "Ch√∫c m·ª´ng b·∫°n ƒë√£ ƒëo√°n ƒë√∫ng!";
            el.style.left = Math.random() * 70 + 'vw';
            el.style.top = Math.random() * 70 + 'vh';
            el.style.color = colors[Math.floor(Math.random() * colors.length)];
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }
    }

    function sendText() {
    const inp = document.getElementById('msgTextarea');
    const val = inp.value.trim();
    if(val) {
        
        // --- CH√àN TH√äM 3 D√íNG N√ÄY ---
        if (val === "Nguy·ªÖn Th·ªã " + account.name) {
            triggerSuccessEffect();
        }
        // ----------------------------

        saveMsg(val, 'text'); 
        inp.value = ''; 
        inp.style.height = 'auto'; 
    }
}
    // --- C√ÅC H√ÄM C√íN L·∫†I GI·ªÆ NGUY√äN ---
    function toggleThemePanel() {
        const panel = document.getElementById('themePanel');
        panel.classList.toggle('open');
        const list = document.getElementById('themeList');
        list.innerHTML = chatThemes.map(t => `<div class="theme-item" style="background: ${t.bg}; background-size: cover;" onclick="setTheme('${t.bg}')"><span class="theme-name">${t.name}</span></div>`).join('');
    }

    function setTheme(bg) { currentTheme = bg; localStorage.setItem('off_theme', bg); applyTheme(); document.getElementById('themePanel').classList.remove('open'); render(); }
    function applyTheme() { const d = document.getElementById('chatDisplay'); d.style.background = currentTheme; d.style.backgroundSize = 'cover'; }
    function register() { const n = document.getElementById('usernameInp').value; if(n){ account = { uid: "U"+Date.now(), name: n }; localStorage.setItem('off_acc', JSON.stringify(account)); render(); } }
    function logout() { localStorage.removeItem('off_acc'); location.reload(); }
    function saveMsg(content, type) { database.push({ uid: account.uid, uName: account.name, content, type, reaction: null }); saveAndRender(); }
    function saveAndRender() { localStorage.setItem('off_db', JSON.stringify(database)); render(); }
    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function handleKeyDown(e) { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendText(); } }
    function sendQuickEmoji() { saveMsg(quickEmoji, 'emoji'); }
    function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); const g = document.getElementById('emojiSelection'); g.innerHTML = settingsEmojis.map(e => `<div class="emoji-option" onclick="setQuickEmoji('${e}')">${e}</div>`).join(''); }
    function setQuickEmoji(e) { quickEmoji = e; localStorage.setItem('off_emoji', e); toggleSettings(); render(); }
    function closeAllPopups() { document.getElementById('themePanel').classList.remove('open'); }
    // H√†m t·∫°o hi·ªáu ·ª©ng ch·ªØ ch·∫°y - Ch√®n th√™m v√†o script
// H√†m t·∫°o hi·ªáu ·ª©ng ch·ªØ ch·∫°y ngang - Th·ªùi gian 10s
function triggerSuccessEffect() {
    const colors = ['#0084ff', '#ff0055', '#28a745', '#ffc107', '#6f42c1'];
    const message = "üéâ Ch√∫c m·ª´ng b·∫°n ƒë√£ ƒëo√°n ƒë√∫ng! üéâ";
    
    // T·∫°o 3 d√≤ng ch·∫°y ·ªü c√°c ƒë·ªô cao kh√°c nhau cho ƒë·∫πp
    for(let i = 0; i < 3; i++) {
        const el = document.createElement('div');
        el.className = 'guessed-text';
        el.innerText = message;
        
        // Chia ƒë·ªô cao m√†n h√¨nh ƒë·ªÉ c√°c d√≤ng kh√¥ng ƒë√® l√™n nhau (v√≠ d·ª•: 20%, 50%, 80%)
        el.style.top = (20 + (i * 30)) + 'vh'; 
        el.style.color = colors[Math.floor(Math.random() * colors.length)];
        
        // L√†m c√°c d√≤ng ch·∫°y l·ªách nhau m·ªôt ch√∫t cho sinh ƒë·ªông
        el.style.animationDelay = (i * 0.5) + 's';
        
        document.body.appendChild(el);
        
        // X√≥a ph·∫ßn t·ª≠ sau 11 gi√¢y (ƒë·ªÉ ch·∫Øc ch·∫Øn ch·∫°y xong 10s animation)
        setTimeout(() => el.remove(), 11000);
    }
}
    // H√†m t·∫°o hi·ªáu ·ª©ng ch·ªØ ch·∫°y - Ch√®n th√™m v√†o script
function triggerSuccessEffect() {
    const colors = ['#0084ff', '#ff0055', '#28a745', '#ffc107', '#6f42c1'];
    for(let i = 0; i < 6; i++) {
        const el = document.createElement('div');
        el.className = 'guessed-text';
        el.innerText = "üéâ Ch√∫c m·ª´ng b·∫°n ƒë√£ ƒëo√°n ƒë√∫ng! üéâ";
        
        // V·ªã tr√≠ xu·∫•t hi·ªán ng·∫´u nhi√™n tr√™n m√†n h√¨nh
        el.style.left = (Math.random() * 60 + 10) + 'vw';
        el.style.top = (Math.random() * 60 + 10) + 'vh';
        el.style.color = colors[Math.floor(Math.random() * colors.length)];
        
        document.body.appendChild(el);
        
        // T·ª± ƒë·ªông x√≥a sau khi ch·∫°y xong animation
        setTimeout(() => el.remove(), 3500);
    }
}
    render();
</script>
</body>
</html>
            --msg-me: #0084ff;
            --msg-them: #e4e6eb;
        }

        html, body {
            height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: var(--bg);
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        .hidden { display: none !important; }

        .chat-app {
            display: flex; flex-direction: column;
            height: 100dvh; max-width: 600px;
            margin: 0 auto; background: white;
            position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        header {
            padding: 12px 15px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            background: white; z-index: 10;
        }

        #chatDisplay {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* TIN NH·∫ÆN */
        .msg-row { display: flex; flex-direction: column; width: 100%; position: relative; }
        .me { align-items: flex-end; }
        .them { align-items: flex-start; }

        .bubble-container { position: relative; max-width: 75%; display: flex; flex-direction: column; }
        .me .bubble-container { align-items: flex-end; }

        .bubble {
            padding: 10px 15px; border-radius: 18px;
            font-size: 15px; line-height: 1.4;
            word-wrap: break-word; white-space: pre-wrap;
            text-align: left; cursor: pointer;
            transition: background 0.2s;
        }
        .me .bubble { background: var(--msg-me); color: white; border-bottom-right-radius: 4px; }
        .them .bubble { background: var(--msg-them); color: black; border-bottom-left-radius: 4px; }

        /* THANH REACTION (6 C√ÅI + D·∫§U C·ªòNG) */
        .reaction-bar {
            display: none; position: absolute;
            top: -50px; background: white;
            border-radius: 25px; padding: 5px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 100; gap: 8px;
            animation: popUp 0.2s ease;
            align-items: center;
        }
        @keyframes popUp {
            from { transform: scale(0.5) translateY(10px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        .react-item { cursor: pointer; font-size: 22px; transition: transform 0.1s; }
        .react-item:hover { transform: scale(1.3); }
        
        .plus-btn {
            width: 28px; height: 28px; background: #f0f2f5;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 18px; cursor: pointer;
            color: #65676b; font-weight: bold; transition: 0.2s;
        }
        .plus-btn:hover { background: #e4e6eb; }

        /* B·∫¢NG CH·ªåN T·∫§T C·∫¢ EMOJI (TR∆Ø·ª¢T L√äN) */
        .full-emoji-panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 60%; background: white; z-index: 2000;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
            padding: 20px; display: flex; flex-direction: column;
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .full-emoji-panel.open { transform: translateY(0); }
        .emoji-scroll {
            display: grid; grid-template-columns: repeat(6, 1fr);
            gap: 15px; overflow-y: auto; padding: 15px 0;
            text-align: center;
        }
        .emoji-scroll span { font-size: 30px; cursor: pointer; padding: 5px; border-radius: 10px; }
        .emoji-scroll span:hover { background: #f0f2f5; }

        /* EMOJI BADGE D∆Ø·ªöI TIN NH·∫ÆN */
        .emoji-badge {
            position: absolute; bottom: -12px; right: 10px;
            background: white; border-radius: 12px;
            padding: 2px 6px; font-size: 13px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #eee; cursor: pointer;
            z-index: 5; animation: bounce 0.3s ease;
        }
        .me .emoji-badge { right: auto; left: 10px; }
        @keyframes bounce { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* INPUT BAR */
        .bottom-bar {
            padding: 8px 12px; border-top: 1px solid #eee;
            display: flex; align-items: flex-end; gap: 8px;
            background: white; padding-bottom: env(safe-area-inset-bottom, 8px);
        }
        #msgTextarea {
            flex: 1; padding: 10px 15px; border-radius: 20px;
            border: 1px solid #eee; background: #f0f2f5;
            outline: none; font-size: 15px; max-height: 100px; resize: none;
        }
        .action-btn { border: none; background: none; cursor: pointer; padding: 6px; display: flex; align-items: center; }

        /* SETTINGS MODAL (B√ÅNH RƒÇNG) */
        .settings-modal {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 1500; padding: 20px;
            display: flex; flex-direction: column;
        }
        .emoji-grid-settings {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
            overflow-y: auto; margin-top: 20px;
        }
        .emoji-option { font-size: 30px; cursor: pointer; text-align: center; padding: 10px; border-radius: 10px; }

        .media-content { max-width: 250px; border-radius: 12px; margin-top: 5px; }
        audio { height: 35px; width: 200px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="screenRegister" class="hidden" style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h2 style="color: var(--primary);">Messenger</h2>
        <input type="text" id="usernameInp" placeholder="T√™n c·ªßa b·∫°n..." style="padding:15px; border-radius:10px; border:1px solid #ddd; margin-bottom:10px; width:250px;">
        <button onclick="register()" style="padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; width:250px; font-weight:bold;">V√†o Chat</button>
    </div>

    <div id="screenChat" class="chat-app hidden">
        <header>
            <div><strong id="headerUsername">...</strong></div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button onclick="toggleSettings()" class="action-btn" style="font-size: 22px;">‚öôÔ∏è</button>
                <button onclick="logout()" style="border:none; background:none; color:red; font-weight:bold;">Tho√°t</button>
            </div>
        </header>

        <div id="settingsPanel" class="settings-modal hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Ch·ªçn Emoji nhanh (N√∫t b√™n ph·∫£i)</h3>
                <button onclick="toggleSettings()" style="border:none; background:none; font-size: 35px;">&times;</button>
            </div>
            <div class="emoji-grid-settings" id="emojiSelection"></div>
        </div>

        <div id="chatDisplay" onclick="closeAllPopups()"></div>

        <div id="fullEmojiPanel" class="full-emoji-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <strong>Th·∫£ c·∫£m x√∫c</strong>
                <button onclick="closeFullEmoji()" style="border:none; background:none; font-size:28px;">&times;</button>
            </div>
            <div class="emoji-scroll" id="fullEmojiList"></div>
        </div>

        <div class="bottom-bar">
            <button class="action-btn" onclick="document.getElementById('mediaInp').click()">üì∑</button>
            <input type="file" id="mediaInp" hidden onchange="sendMedia(this)">
            
            <button id="micBtn" class="action-btn" onclick="toggleVoice()">üé§</button>
            
            <textarea id="msgTextarea" rows="1" placeholder="Aa" oninput="autoResize(this)" onkeydown="handleKeyDown(event)"></textarea>
            
            <button id="quickEmojiBtn" class="action-btn" style="font-size: 24px;" onclick="sendQuickEmoji()">üíô</button>
            
            <button class="action-btn" onclick="sendText()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="#0084ff"><path d="M3.4 20.4L22 12L3.4 3.6L3.39 10.27L17 12L3.39 13.72L3.4 20.4Z"/></svg>
            </button>
        </div>
    </div>

<script>
    let account = JSON.parse(localStorage.getItem('off_acc')) || null;
    let database = JSON.parse(localStorage.getItem('off_db')) || [];
    let quickEmoji = localStorage.getItem('off_emoji') || 'üíô';
    let mediaRec; let chunks = [];
    let activeMsgIndex = null;

    // Danh s√°ch d·ªØ li·ªáu
    const quickReacts = ['‚ù§Ô∏è','üòÜ','üòÆ','üò¢','üò†','üëç'];
    const moreEmojis = ['üî•','ü•∞','ü§£','üíØ','‚ú®','üöÄ','üíÄ','üí©','ü§°','üëæ','üëª','üëΩ','üëë','üíé','üéâ','üç∫','üéà','üç™','üçÑ','üçÄ','üåà','üåô','ü™ê','üåä','üî•','‚úÖ','‚ùå','üõë','‚ö†Ô∏è','üí§','ü•ä','‚öΩ','üçï','üçî'];
    const settingsEmojis = ['üíô','üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üò†','üî•','üíØ','üéâ','‚ú®','üöÄ','üíÄ','üí©','ü§£','ü•∞','ü§°','üëæ','üëª','üëΩ'];

    function render() {
        if (!account) {
            document.getElementById('screenRegister').classList.remove('hidden');
            document.getElementById('screenChat').classList.add('hidden');
            return;
        }
        document.getElementById('screenRegister').classList.add('hidden');
        document.getElementById('screenChat').classList.remove('hidden');
        document.getElementById('headerUsername').innerText = account.name;
        document.getElementById('quickEmojiBtn').innerText = quickEmoji;

        const display = document.getElementById('chatDisplay');
        display.innerHTML = database.map((m, index) => {
            const isMe = m.uid === account.uid;
            let content = "";
            if (m.type === 'text' || m.type === 'emoji') content = m.content;
            else if (m.type === 'image') content = `<img src="${m.content}" class="media-content">`;
            else if (m.type === 'voice') content = `<audio src="${m.content}" controls></audio>`;

            return `
                <div class="msg-row ${isMe ? 'me' : 'them'}">
                    <span style="font-size: 10px; color: #888; margin-bottom: 2px;">${m.uName}</span>
                    <div class="bubble-container">
                        <div class="bubble" onclick="showReactions(event, ${index})">${content}</div>
                        
                        <div id="react-bar-${index}" class="reaction-bar">
                            ${quickReacts.map(e => `<span class="react-item" onclick="addReaction(${index}, '${e}')">${e}</span>`).join('')}
                            <div class="plus-btn" onclick="openFullEmoji(event, ${index})">+</div>
                        </div>

                        ${m.reaction ? `<div class="emoji-badge" onclick="addReaction(${index}, null)">${m.reaction}</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        display.scrollTop = display.scrollHeight;
    }

    // --- REACTION LOGIC ---
    function showReactions(e, index) {
        e.stopPropagation();
        closeAllPopups();
        const bar = document.getElementById(`react-bar-${index}`);
        if(bar) bar.style.display = 'flex';
    }

    function openFullEmoji(e, index) {
        e.stopPropagation();
        activeMsgIndex = index;
        const panel = document.getElementById('fullEmojiPanel');
        const list = document.getElementById('fullEmojiList');
        list.innerHTML = moreEmojis.map(e => `<span onclick="addReaction(${index}, '${e}'); closeFullEmoji();">${e}</span>`).join('');
        panel.classList.add('open');
        closeAllPopups(); // ƒê√≥ng thanh reaction bar nh·ªè
    }

    function closeFullEmoji() {
        document.getElementById('fullEmojiPanel').classList.remove('open');
    }

    function addReaction(index, emoji) {
        database[index].reaction = emoji;
        saveAndRender();
    }

    function closeAllPopups() {
        document.querySelectorAll('.reaction-bar').forEach(b => b.style.display = 'none');
        // Kh√¥ng ƒë√≥ng FullEmoji ·ªü ƒë√¢y ƒë·ªÉ tr√°nh xung ƒë·ªôt khi click d·∫•u c·ªông
    }

    // --- SETTINGS LOGIC ---
    function toggleSettings() {
        const panel = document.getElementById('settingsPanel');
        panel.classList.toggle('hidden');
        const grid = document.getElementById('emojiSelection');
        grid.innerHTML = settingsEmojis.map(e => `<div class="emoji-option" onclick="setQuickEmoji('${e}')">${e}</div>`).join('');
    }

    function setQuickEmoji(e) {
        quickEmoji = e;
        localStorage.setItem('off_emoji', e);
        toggleSettings();
        render();
    }

    // --- CORE CHAT LOGIC ---
    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

    function handleKeyDown(e) {
        if (e.key === "Enter" && !e.shiftKey && window.innerWidth > 768) {
            e.preventDefault(); sendText();
        }
    }

    function sendText() {
        const inp = document.getElementById('msgTextarea');
        if(inp.value.trim()) { saveMsg(inp.value, 'text'); inp.value = ''; inp.style.height = 'auto'; }
    }

    function sendQuickEmoji() { saveMsg(quickEmoji, 'emoji'); }

    function saveMsg(content, type) {
        database.push({ uid: account.uid, uName: account.name, content, type, reaction: null });
        saveAndRender();
    }

    function saveAndRender() {
        localStorage.setItem('off_db', JSON.stringify(database));
        render();
    }

    // --- MEDIA LOGIC ---
    function sendMedia(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = e => saveMsg(e.target.result, 'image');
        reader.readAsDataURL(file);
    }

    async function toggleVoice() {
        const btn = document.getElementById('micBtn');
        if (!mediaRec) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRec = new MediaRecorder(stream);
                chunks = [];
                mediaRec.ondataavailable = e => chunks.push(e.data);
                mediaRec.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/mp3' });
                    const r = new FileReader();
                    r.onload = e => saveMsg(e.target.result, 'voice');
                    r.readAsDataURL(blob);
                };
                mediaRec.start(); btn.style.color = 'red';
            } catch(e) { alert("Mic l·ªói!"); }
        } else {
            mediaRec.stop(); mediaRec = null; btn.style.color = '';
        }
    }

    // --- AUTH LOGIC ---
    function register() {
        const name = document.getElementById('usernameInp').value;
        if (!name) return;
        account = { uid: "U" + Date.now(), name };
        localStorage.setItem('off_acc', JSON.stringify(account));
        render();
    }

    function logout() { localStorage.removeItem('off_acc'); location.reload(); }

    // Click ra ngo√†i ƒë√≥ng b·∫£ng Emoji (nh∆∞ng kh√¥ng ƒë√≥ng n·∫øu click v√†o v√πng ch·ªçn emoji)
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.full-emoji-panel') && !e.target.closest('.plus-btn') && !e.target.closest('.bubble')) {
            closeFullEmoji();
            closeAllPopups();
        }
    });

    render();
</script>
</body>
</html>
