<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger Pro Max - Full Features</title>
    <style>
        :root {
            --primary: #0084ff;
            --bg: #f0f2f5;
            --msg-me: #0084ff;
            --msg-them: #e4e6eb;
        }

        html, body {
            height: 100%; margin: 0; padding: 0;
            overflow: hidden; background-color: var(--bg);
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        .hidden { display: none !important; }

        .chat-app {
            display: flex; flex-direction: column;
            height: 100dvh; max-width: 600px;
            margin: 0 auto; background: white;
            position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        header {
            padding: 12px 15px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            background: white; z-index: 10;
        }

        #chatDisplay {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* TIN NH·∫ÆN */
        .msg-row { display: flex; flex-direction: column; width: 100%; position: relative; }
        .me { align-items: flex-end; }
        .them { align-items: flex-start; }

        .bubble-container { position: relative; max-width: 75%; display: flex; flex-direction: column; }
        .me .bubble-container { align-items: flex-end; }

        .bubble {
            padding: 10px 15px; border-radius: 18px;
            font-size: 15px; line-height: 1.4;
            word-wrap: break-word; white-space: pre-wrap;
            text-align: left; cursor: pointer;
            transition: background 0.2s;
        }
        .me .bubble { background: var(--msg-me); color: white; border-bottom-right-radius: 4px; }
        .them .bubble { background: var(--msg-them); color: black; border-bottom-left-radius: 4px; }

        /* THANH REACTION (6 C√ÅI + D·∫§U C·ªòNG) */
        .reaction-bar {
            display: none; position: absolute;
            top: -50px; background: white;
            border-radius: 25px; padding: 5px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 100; gap: 8px;
            animation: popUp 0.2s ease;
            align-items: center;
        }
        @keyframes popUp {
            from { transform: scale(0.5) translateY(10px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        .react-item { cursor: pointer; font-size: 22px; transition: transform 0.1s; }
        .react-item:hover { transform: scale(1.3); }
        
        .plus-btn {
            width: 28px; height: 28px; background: #f0f2f5;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 18px; cursor: pointer;
            color: #65676b; font-weight: bold; transition: 0.2s;
        }
        .plus-btn:hover { background: #e4e6eb; }

        /* B·∫¢NG CH·ªåN T·∫§T C·∫¢ EMOJI (TR∆Ø·ª¢T L√äN) */
        .full-emoji-panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 60%; background: white; z-index: 2000;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
            padding: 20px; display: flex; flex-direction: column;
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .full-emoji-panel.open { transform: translateY(0); }
        .emoji-scroll {
            display: grid; grid-template-columns: repeat(6, 1fr);
            gap: 15px; overflow-y: auto; padding: 15px 0;
            text-align: center;
        }
        .emoji-scroll span { font-size: 30px; cursor: pointer; padding: 5px; border-radius: 10px; }
        .emoji-scroll span:hover { background: #f0f2f5; }

        /* EMOJI BADGE D∆Ø·ªöI TIN NH·∫ÆN */
        .emoji-badge {
            position: absolute; bottom: -12px; right: 10px;
            background: white; border-radius: 12px;
            padding: 2px 6px; font-size: 13px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #eee; cursor: pointer;
            z-index: 5; animation: bounce 0.3s ease;
        }
        .me .emoji-badge { right: auto; left: 10px; }
        @keyframes bounce { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* INPUT BAR */
        .bottom-bar {
            padding: 8px 12px; border-top: 1px solid #eee;
            display: flex; align-items: flex-end; gap: 8px;
            background: white; padding-bottom: env(safe-area-inset-bottom, 8px);
        }
        #msgTextarea {
            flex: 1; padding: 10px 15px; border-radius: 20px;
            border: 1px solid #eee; background: #f0f2f5;
            outline: none; font-size: 15px; max-height: 100px; resize: none;
        }
        .action-btn { border: none; background: none; cursor: pointer; padding: 6px; display: flex; align-items: center; }

        /* SETTINGS MODAL (B√ÅNH RƒÇNG) */
        .settings-modal {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 1500; padding: 20px;
            display: flex; flex-direction: column;
        }
        .emoji-grid-settings {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;
            overflow-y: auto; margin-top: 20px;
        }
        .emoji-option { font-size: 30px; cursor: pointer; text-align: center; padding: 10px; border-radius: 10px; }

        .media-content { max-width: 250px; border-radius: 12px; margin-top: 5px; }
        audio { height: 35px; width: 200px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="screenRegister" class="hidden" style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h2 style="color: var(--primary);">Messenger</h2>
        <input type="text" id="usernameInp" placeholder="T√™n c·ªßa b·∫°n..." style="padding:15px; border-radius:10px; border:1px solid #ddd; margin-bottom:10px; width:250px;">
        <button onclick="register()" style="padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; width:250px; font-weight:bold;">V√†o Chat</button>
    </div>

    <div id="screenChat" class="chat-app hidden">
        <header>
            <div><strong id="headerUsername">...</strong></div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button onclick="toggleSettings()" class="action-btn" style="font-size: 22px;">‚öôÔ∏è</button>
                <button onclick="logout()" style="border:none; background:none; color:red; font-weight:bold;">Tho√°t</button>
            </div>
        </header>

        <div id="settingsPanel" class="settings-modal hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Ch·ªçn Emoji nhanh (N√∫t b√™n ph·∫£i)</h3>
                <button onclick="toggleSettings()" style="border:none; background:none; font-size: 35px;">&times;</button>
            </div>
            <div class="emoji-grid-settings" id="emojiSelection"></div>
        </div>

        <div id="chatDisplay" onclick="closeAllPopups()"></div>

        <div id="fullEmojiPanel" class="full-emoji-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <strong>Th·∫£ c·∫£m x√∫c</strong>
                <button onclick="closeFullEmoji()" style="border:none; background:none; font-size:28px;">&times;</button>
            </div>
            <div class="emoji-scroll" id="fullEmojiList"></div>
        </div>

        <div class="bottom-bar">
            <button class="action-btn" onclick="document.getElementById('mediaInp').click()">üì∑</button>
            <input type="file" id="mediaInp" hidden onchange="sendMedia(this)">
            
            <button id="micBtn" class="action-btn" onclick="toggleVoice()">üé§</button>
            
            <textarea id="msgTextarea" rows="1" placeholder="Aa" oninput="autoResize(this)" onkeydown="handleKeyDown(event)"></textarea>
            
            <button id="quickEmojiBtn" class="action-btn" style="font-size: 24px;" onclick="sendQuickEmoji()">üíô</button>
            
            <button class="action-btn" onclick="sendText()">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="#0084ff"><path d="M3.4 20.4L22 12L3.4 3.6L3.39 10.27L17 12L3.39 13.72L3.4 20.4Z"/></svg>
            </button>
        </div>
    </div>

<script>
    let account = JSON.parse(localStorage.getItem('off_acc')) || null;
    let database = JSON.parse(localStorage.getItem('off_db')) || [];
    let quickEmoji = localStorage.getItem('off_emoji') || 'üíô';
    let mediaRec; let chunks = [];
    let activeMsgIndex = null;

    // Danh s√°ch d·ªØ li·ªáu
    const quickReacts = ['‚ù§Ô∏è','üòÜ','üòÆ','üò¢','üò†','üëç'];
    const moreEmojis = ['üî•','ü•∞','ü§£','üíØ','‚ú®','üöÄ','üíÄ','üí©','ü§°','üëæ','üëª','üëΩ','üëë','üíé','üéâ','üç∫','üéà','üç™','üçÑ','üçÄ','üåà','üåô','ü™ê','üåä','üî•','‚úÖ','‚ùå','üõë','‚ö†Ô∏è','üí§','ü•ä','‚öΩ','üçï','üçî'];
    const settingsEmojis = ['üíô','üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üò†','üî•','üíØ','üéâ','‚ú®','üöÄ','üíÄ','üí©','ü§£','ü•∞','ü§°','üëæ','üëª','üëΩ'];

    function render() {
        if (!account) {
            document.getElementById('screenRegister').classList.remove('hidden');
            document.getElementById('screenChat').classList.add('hidden');
            return;
        }
        document.getElementById('screenRegister').classList.add('hidden');
        document.getElementById('screenChat').classList.remove('hidden');
        document.getElementById('headerUsername').innerText = account.name;
        document.getElementById('quickEmojiBtn').innerText = quickEmoji;

        const display = document.getElementById('chatDisplay');
        display.innerHTML = database.map((m, index) => {
            const isMe = m.uid === account.uid;
            let content = "";
            if (m.type === 'text' || m.type === 'emoji') content = m.content;
            else if (m.type === 'image') content = `<img src="${m.content}" class="media-content">`;
            else if (m.type === 'voice') content = `<audio src="${m.content}" controls></audio>`;

            return `
                <div class="msg-row ${isMe ? 'me' : 'them'}">
                    <span style="font-size: 10px; color: #888; margin-bottom: 2px;">${m.uName}</span>
                    <div class="bubble-container">
                        <div class="bubble" onclick="showReactions(event, ${index})">${content}</div>
                        
                        <div id="react-bar-${index}" class="reaction-bar">
                            ${quickReacts.map(e => `<span class="react-item" onclick="addReaction(${index}, '${e}')">${e}</span>`).join('')}
                            <div class="plus-btn" onclick="openFullEmoji(event, ${index})">+</div>
                        </div>

                        ${m.reaction ? `<div class="emoji-badge" onclick="addReaction(${index}, null)">${m.reaction}</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');
        display.scrollTop = display.scrollHeight;
    }

    // --- REACTION LOGIC ---
    function showReactions(e, index) {
        e.stopPropagation();
        closeAllPopups();
        const bar = document.getElementById(`react-bar-${index}`);
        if(bar) bar.style.display = 'flex';
    }

    function openFullEmoji(e, index) {
        e.stopPropagation();
        activeMsgIndex = index;
        const panel = document.getElementById('fullEmojiPanel');
        const list = document.getElementById('fullEmojiList');
        list.innerHTML = moreEmojis.map(e => `<span onclick="addReaction(${index}, '${e}'); closeFullEmoji();">${e}</span>`).join('');
        panel.classList.add('open');
        closeAllPopups(); // ƒê√≥ng thanh reaction bar nh·ªè
    }

    function closeFullEmoji() {
        document.getElementById('fullEmojiPanel').classList.remove('open');
    }

    function addReaction(index, emoji) {
        database[index].reaction = emoji;
        saveAndRender();
    }

    function closeAllPopups() {
        document.querySelectorAll('.reaction-bar').forEach(b => b.style.display = 'none');
        // Kh√¥ng ƒë√≥ng FullEmoji ·ªü ƒë√¢y ƒë·ªÉ tr√°nh xung ƒë·ªôt khi click d·∫•u c·ªông
    }

    // --- SETTINGS LOGIC ---
    function toggleSettings() {
        const panel = document.getElementById('settingsPanel');
        panel.classList.toggle('hidden');
        const grid = document.getElementById('emojiSelection');
        grid.innerHTML = settingsEmojis.map(e => `<div class="emoji-option" onclick="setQuickEmoji('${e}')">${e}</div>`).join('');
    }

    function setQuickEmoji(e) {
        quickEmoji = e;
        localStorage.setItem('off_emoji', e);
        toggleSettings();
        render();
    }

    // --- CORE CHAT LOGIC ---
    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }

    function handleKeyDown(e) {
        if (e.key === "Enter" && !e.shiftKey && window.innerWidth > 768) {
            e.preventDefault(); sendText();
        }
    }

    function sendText() {
        const inp = document.getElementById('msgTextarea');
        if(inp.value.trim()) { saveMsg(inp.value, 'text'); inp.value = ''; inp.style.height = 'auto'; }
    }

    function sendQuickEmoji() { saveMsg(quickEmoji, 'emoji'); }

    function saveMsg(content, type) {
        database.push({ uid: account.uid, uName: account.name, content, type, reaction: null });
        saveAndRender();
    }

    function saveAndRender() {
        localStorage.setItem('off_db', JSON.stringify(database));
        render();
    }

    // --- MEDIA LOGIC ---
    function sendMedia(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = e => saveMsg(e.target.result, 'image');
        reader.readAsDataURL(file);
    }

    async function toggleVoice() {
        const btn = document.getElementById('micBtn');
        if (!mediaRec) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRec = new MediaRecorder(stream);
                chunks = [];
                mediaRec.ondataavailable = e => chunks.push(e.data);
                mediaRec.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/mp3' });
                    const r = new FileReader();
                    r.onload = e => saveMsg(e.target.result, 'voice');
                    r.readAsDataURL(blob);
                };
                mediaRec.start(); btn.style.color = 'red';
            } catch(e) { alert("Mic l·ªói!"); }
        } else {
            mediaRec.stop(); mediaRec = null; btn.style.color = '';
        }
    }

    // --- AUTH LOGIC ---
    function register() {
        const name = document.getElementById('usernameInp').value;
        if (!name) return;
        account = { uid: "U" + Date.now(), name };
        localStorage.setItem('off_acc', JSON.stringify(account));
        render();
    }

    function logout() { localStorage.removeItem('off_acc'); location.reload(); }

    // Click ra ngo√†i ƒë√≥ng b·∫£ng Emoji (nh∆∞ng kh√¥ng ƒë√≥ng n·∫øu click v√†o v√πng ch·ªçn emoji)
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.full-emoji-panel') && !e.target.closest('.plus-btn') && !e.target.closest('.bubble')) {
            closeFullEmoji();
            closeAllPopups();
        }
    });

    render();
</script>
</body>
</html>
