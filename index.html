<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger Offline Pro - Fixed</title>
    <style>
        :root { --primary: #0084ff; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; height: 100vh; }
        .hidden { display: none !important; }

        /* M√†n h√¨nh ƒëƒÉng k√Ω */
        .auth-box { align-self: center; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 320px; }
        .auth-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-start { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Giao di·ªán ch√≠nh */
        .chat-container { width: 100%; max-width: 500px; background: white; display: flex; flex-direction: column; height: 100vh; }
        header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        #chatDisplay { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }

        /* Bong b√≥ng chat */
        .msg-wrapper { display: flex; flex-direction: column; max-width: 75%; }
        .msg-wrapper.mine { align-self: flex-end; align-items: flex-end; }
        .msg-wrapper.others { align-self: flex-start; align-items: flex-start; }
        .sender-name { font-size: 11px; color: #65676b; margin-bottom: 2px; }
        .msg-bubble { padding: 10px 16px; border-radius: 18px; font-size: 15px; word-wrap: break-word; position: relative; }
        .mine .msg-bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .others .msg-bubble { background: #e4e6eb; color: black; border-bottom-left-radius: 4px; }

        .msg-img { max-width: 200px; border-radius: 10px; margin-top: 5px; }
        audio { height: 35px; width: 210px; margin-top: 5px; }

        /* N√∫t x√≥a */
        .btn-del { cursor: pointer; color: #ccc; font-size: 12px; margin-top: 2px; border: none; background: none; }
        .btn-del:hover { color: #ff4d4d; }

        /* Thanh nh·∫≠p li·ªáu */
        .input-area { padding: 15px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        #msgInp { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #eee; background: #f0f2f5; outline: none; }
        .btn-icon { font-size: 22px; border: none; background: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-icon:hover { transform: scale(1.1); }
        .recording { color: red; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="authScreen" class="auth-box hidden">
        <h2 style="color: var(--primary)">Ch√†o m·ª´ng!</h2>
        <input type="text" id="regName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
        <button class="btn-start" onclick="App.register()">V√†o Chat</button>
    </div>

    <div id="chatScreen" class="chat-container hidden">
        <header>
            <div>
                <strong id="headerName">...</strong>
                <div style="font-size: 10px; color: #31a24c">‚óè ƒêang ho·∫°t ƒë·ªông</div>
            </div>
            <button onclick="App.logout()" style="border:none; background:none; color:#999; cursor:pointer;">ƒêƒÉng xu·∫•t</button>
        </header>

        <div id="chatDisplay"></div>

        <div class="input-area">
            <input type="file" id="fileInp" hidden accept="image/*" onchange="App.sendImage(this)">
            <button class="btn-icon" onclick="document.getElementById('fileInp').click()">üñºÔ∏è</button>
            <button id="recordBtn" class="btn-icon" onclick="App.toggleRecord()">üé§</button>
            
            <input type="text" id="msgInp" placeholder="Aa" onkeypress="if(event.key === 'Enter') App.sendMessage()">
            
            <button class="btn-icon" onclick="App.sendMessage()" title="G·ª≠i">üíô</button>
        </div>
    </div>

<script>
    const App = (() => {
        // Kh·ªüi t·∫°o d·ªØ li·ªáu
        const state = new Proxy({
            currentUser: JSON.parse(localStorage.getItem('chat_acc_v3')) || null,
            messages: JSON.parse(localStorage.getItem('chat_db_v3')) || []
        }, {
            set(target, prop, value) {
                target[prop] = value;
                localStorage.setItem('chat_acc_v3', JSON.stringify(target.currentUser));
                localStorage.setItem('chat_db_v3', JSON.stringify(target.messages));
                render();
                return true;
            }
        });

        let mediaRec;
        let chunks = [];

        function render() {
            const auth = document.getElementById('authScreen');
            const chat = document.getElementById('chatScreen');
            
            if (!state.currentUser) {
                auth.classList.remove('hidden');
                chat.classList.add('hidden');
                return;
            }

            auth.classList.add('hidden');
            chat.classList.remove('hidden');
            document.getElementById('headerName').innerText = state.currentUser.name;

            const display = document.getElementById('chatDisplay');
            display.innerHTML = state.messages.map((m, index) => `
                <div class="msg-wrapper ${m.uid === state.currentUser.uid ? 'mine' : 'others'}">
                    <span class="sender-name">${m.userName}</span>
                    <div class="msg-bubble">
                        ${m.type === 'text' ? m.content : 
                          m.type === 'image' ? `<img src="${m.content}" class="msg-img">` :
                          `<audio src="${m.content}" controls></audio>`}
                    </div>
                    <button class="btn-del" onclick="App.deleteMessage(${index})">X√≥a</button>
                </div>
            `).join('');
            display.scrollTop = display.scrollHeight;
        }

        return {
            register() {
                const name = document.getElementById('regName').value.trim();
                if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n!");
                state.currentUser = { uid: Date.now().toString(), name: name };
            },
            logout() {
                if(confirm("B·∫°n c√≥ mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?")) state.currentUser = null;
            },
            // ƒê·∫£m b·∫£o h√†m n√†y tr√πng t√™n v·ªõi l·ªánh g·ªçi ·ªü n√∫t Tr√°i tim
            sendMessage() {
                const inp = document.getElementById('msgInp');
                const val = inp.value.trim();
                if (!val) return;

                state.messages = [...state.messages, {
                    uid: state.currentUser.uid,
                    userName: state.currentUser.name,
                    content: val,
                    type: 'text'
                }];
                inp.value = '';
                inp.focus();
            },
            sendImage(inp) {
                const file = inp.files[0];
                if (!file) return;
                const r = new FileReader();
                r.onload = e => {
                    state.messages = [...state.messages, {
                        uid: state.currentUser.uid,
                        userName: state.currentUser.name,
                        content: e.target.result,
                        type: 'image'
                    }];
                    inp.value = '';
                };
                r.readAsDataURL(file);
            },
            async toggleRecord() {
                const btn = document.getElementById('recordBtn');
                if (!mediaRec) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRec = new MediaRecorder(stream);
                        chunks = [];
                        mediaRec.ondataavailable = e => chunks.push(e.data);
                        mediaRec.onstop = () => {
                            const blob = new Blob(chunks, { type: 'audio/webm' });
                            const r = new FileReader();
                            r.onload = e => {
                                state.messages = [...state.messages, {
                                    uid: state.currentUser.uid,
                                    userName: state.currentUser.name,
                                    content: e.target.result,
                                    type: 'voice'
                                }];
                            };
                            r.readAsDataURL(blob);
                        };
                        mediaRec.start();
                        btn.classList.add('recording');
                    } catch (err) { alert("Kh√¥ng th·ªÉ truy c·∫≠p Microphone!"); }
                } else {
                    mediaRec.stop();
                    mediaRec = null;
                    btn.classList.remove('recording');
                }
            },
            deleteMessage(index) {
                if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tin nh·∫Øn n√†y kh√¥ng?")) {
                    const newMsgs = [...state.messages];
                    newMsgs.splice(index, 1);
                    state.messages = newMsgs;
                }
            },
            init: render
        };
    })();

    App.init();
</script>
</body>
</html>
