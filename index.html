<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messenger Offline Pro - Super Stable</title>
    <style>
        :root { --primary-color: #0084ff; --bg-color: #f0f2f5; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: var(--bg-color); margin: 0; display: flex; justify-content: center; height: 100vh; }
        
        /* ·∫®n hi·ªán c√°c m√†n h√¨nh */
        .hidden { display: none !important; }

        /* M√ÄN H√åNH ƒêƒÇNG K√ù */
        #man_hinh_dang_ky { align-self: center; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 320px; }
        #man_hinh_dang_ky input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-bat-dau { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* GIAO DI·ªÜN CHAT CH√çNH */
        .chat-container { width: 100%; max-width: 500px; background: white; display: flex; flex-direction: column; height: 100vh; position: relative; }
        header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        #khung_hien_thi_chat { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background-color: #ffffff; }

        /* Bong b√≥ng chat */
        .tin-nhan-wrapper { display: flex; flex-direction: column; max-width: 75%; margin-bottom: 5px; }
        .tin-nhan-cua-toi { align-self: flex-end; align-items: flex-end; }
        .tin-nhan-nguoi-khac { align-self: flex-start; align-items: flex-start; }
        
        .ten-nguoi-gui { font-size: 11px; color: #65676b; margin-bottom: 2px; }
        .noi-dung-bubble { padding: 10px 16px; border-radius: 18px; font-size: 15px; word-wrap: break-word; position: relative; }
        
        .tin-nhan-cua-toi .noi-dung-bubble { background: var(--primary-color); color: white; border-bottom-right-radius: 4px; }
        .tin-nhan-nguoi-khac .noi-dung-bubble { background: #e4e6eb; color: black; border-bottom-left-radius: 4px; }

        .anh-da-gui { max-width: 200px; border-radius: 10px; margin-top: 5px; display: block; }
        audio { height: 35px; width: 200px; margin-top: 5px; }

        .nut-xoa-tin { cursor: pointer; color: #ccc; font-size: 11px; border: none; background: none; margin-top: 2px; }
        .nut-xoa-tin:hover { color: red; }

        /* KHU V·ª∞C NH·∫¨P TIN NH·∫ÆN */
        .vung-nhap-lieu { padding: 15px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; background: white; }
        #o_nhap_tin_nhan { flex: 1; padding: 12px 15px; border-radius: 20px; border: 1px solid #eee; background: #f0f2f5; outline: none; font-size: 15px; }
        
        .nut-icon { font-size: 24px; border: none; background: none; cursor: pointer; display: flex; align-items: center; transition: 0.2s; padding: 0; }
        .nut-icon:hover { transform: scale(1.2); }
        .dang-ghi-am { color: red; animation: nhap_nhay 1s infinite; }
        
        @keyframes nhap_nhay { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="man_hinh_dang_ky">
        <h2 style="color: var(--primary-color)">T·∫°o T√†i Kho·∫£n</h2>
        <input type="text" id="ten_nguoi_dung_moi" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
        <button class="btn-bat-dau" onclick="XU_LY_DANG_KY()">B·∫Øt ƒë·∫ßu Chat</button>
    </div>

    <div id="man_hinh_chat" class="chat-container hidden">
        <header>
            <div>
                <strong id="ten_hien_thi_tren_dau">ƒêang t·∫£i...</strong>
                <div style="font-size: 10px; color: #31a24c">‚óè ƒêang ho·∫°t ƒë·ªông</div>
            </div>
            <button onclick="XU_LY_DANG_XUAT()" style="border:none; background:none; color:#999; cursor:pointer;">ƒêƒÉng xu·∫•t</button>
        </header>

        <div id="khung_hien_thi_chat">
            </div>

        <div class="vung-nhap-lieu">
            <input type="file" id="chon_file_anh" hidden accept="image/*" onchange="XU_LY_GUI_ANH(this)">
            <button class="nut-icon" onclick="document.getElementById('chon_file_anh').click()">üñºÔ∏è</button>
            
            <button id="nut_ghi_am" class="nut-icon" onclick="XU_LY_GHI_AM()">üé§</button>
            
            <input type="text" id="o_nhap_tin_nhan" placeholder="Aa" onkeypress="if(event.key === 'Enter') HAM_GUI_TIN_NHAN_CHINH()">
            
            <button class="nut-icon" id="nut_gui_tin_nhan" onclick="HAM_GUI_TIN_NHAN_CHINH()">
                üíô
            </button>
        </div>
    </div>

<script>
    /* --- PH·∫¶N 1: QU·∫¢N L√ù D·ªÆ LI·ªÜU (DATABASE OFFLINE) --- */
    let TAI_KHOAN_HIEN_TAI = JSON.parse(localStorage.getItem('user_acc')) || null;
    let DANH_SACH_TIN_NHAN = JSON.parse(localStorage.getItem('chat_data')) || [];

    /* --- PH·∫¶N 2: C√ÅC H√ÄM X·ª¨ L√ù CH√çNH --- */

    // H√†m hi·ªÉn th·ªã tin nh·∫Øn ra m√†n h√¨nh
    function VE_LAI_GIAO_DIEN() {
        const authScreen = document.getElementById('man_hinh_dang_ky');
        const chatScreen = document.getElementById('man_hinh_chat');
        const listChat = document.getElementById('khung_hien_thi_chat');

        // Ki·ªÉm tra xem ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
        if (!TAI_KHOAN_HIEN_TAI) {
            authScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
            return;
        }

        // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, hi·ªán m√†n h√¨nh chat
        authScreen.classList.add('hidden');
        chatScreen.classList.remove('hidden');
        document.getElementById('ten_hien_thi_tren_dau').innerText = TAI_KHOAN_HIEN_TAI.name;

        // V·∫Ω t·ª´ng tin nh·∫Øn
        listChat.innerHTML = DANH_SACH_TIN_NHAN.map((msg, index) => {
            const laToi = msg.uid === TAI_KHOAN_HIEN_TAI.uid;
            return `
                <div class="tin-nhan-wrapper ${laToi ? 'tin-nhan-cua-toi' : 'tin-nhan-nguoi-khac'}">
                    <span class="ten-nguoi-gui">${msg.userName}</span>
                    <div class="noi-dung-bubble">
                        ${msg.type === 'text' ? msg.content : 
                          msg.type === 'image' ? `<img src="${msg.content}" class="anh-da-gui">` :
                          `<audio src="${msg.content}" controls></audio>`}
                    </div>
                    <button class="nut-xoa-tin" onclick="XU_LY_XOA_TIN(${index})">X√≥a</button>
                </div>
            `;
        }).join('');

        // Cu·ªôn xu·ªëng cu·ªëi
        listChat.scrollTop = listChat.scrollHeight;
    }

    // H√ÄM G·ª¨I TIN NH·∫ÆN (Khi b·∫•m n√∫t Tr√°i tim ho·∫∑c Enter)
    function HAM_GUI_TIN_NHAN_CHINH() {
        const input = document.getElementById('o_nhap_tin_nhan');
        const text = input.value.trim();

        if (text === "") return; // Kh√¥ng l√†m g√¨ n·∫øu ƒë·ªÉ tr·ªëng

        // L∆∞u tin nh·∫Øn v√†o m·∫£ng
        const tinMoi = {
            uid: TAI_KHOAN_HIEN_TAI.uid,
            userName: TAI_KHOAN_HIEN_TAI.name,
            content: text,
            type: 'text'
        };

        DANH_SACH_TIN_NHAN.push(tinMoi);
        
        // L∆∞u v√†o b·ªô nh·ªõ m√°y t√≠nh
        localStorage.setItem('chat_data', JSON.stringify(DANH_SACH_TIN_NHAN));

        // X√≥a √¥ nh·∫≠p v√† v·∫Ω l·∫°i
        input.value = "";
        VE_LAI_GIAO_DIEN();
        input.focus();
    }

    // X·ª≠ l√Ω ƒëƒÉng k√Ω
    function XU_LY_DANG_KY() {
        const inputName = document.getElementById('ten_nguoi_dung_moi');
        const name = inputName.value.trim();
        if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n!");

        TAI_KHOAN_HIEN_TAI = { uid: "ID_" + Date.now(), name: name };
        localStorage.setItem('user_acc', JSON.stringify(TAI_KHOAN_HIEN_TAI));
        VE_LAI_GIAO_DIEN();
    }

    // X·ª≠ l√Ω ƒëƒÉng xu·∫•t
    function XU_LY_DANG_XUAT() {
        if (confirm("B·∫°n c√≥ mu·ªën tho√°t v√† ƒë·ªïi t√™n kh√°c?")) {
            TAI_KHOAN_HIEN_TAI = null;
            localStorage.removeItem('user_acc');
            VE_LAI_GIAO_DIEN();
        }
    }

    // X·ª≠ l√Ω x√≥a tin (C√≥ h·ªèi l·∫°i)
    function XU_LY_XOA_TIN(index) {
        const xacNhan = confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tin nh·∫Øn n√†y kh√¥ng?");
        if (xacNhan) {
            DANH_SACH_TIN_NHAN.splice(index, 1);
            localStorage.setItem('chat_data', JSON.stringify(DANH_SACH_TIN_NHAN));
            VE_LAI_GIAO_DIEN();
        }
    }

    // X·ª≠ l√Ω g·ª≠i ·∫£nh
    function XU_LY_GUI_ANH(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            DANH_SACH_TIN_NHAN.push({
                uid: TAI_KHOAN_HIEN_TAI.uid,
                userName: TAI_KHOAN_HIEN_TAI.name,
                content: e.target.result,
                type: 'image'
            });
            localStorage.setItem('chat_data', JSON.stringify(DANH_SACH_TIN_NHAN));
            VE_LAI_GIAO_DIEN();
            input.value = ""; // Reset
        };
        reader.readAsDataURL(file);
    }

    // X·ª≠ l√Ω ghi √¢m (Voice)
    let b√¥_ghi_am;
    let du_lieu_am_thanh = [];
    function XU_LY_GHI_AM() {
        const nut = document.getElementById('nut_ghi_am');
        if (!b√¥_ghi_am) {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                b√¥_ghi_am = new MediaRecorder(stream);
                du_lieu_am_thanh = [];
                b√¥_ghi_am.ondataavailable = e => du_lieu_am_thanh.push(e.data);
                b√¥_ghi_am.onstop = () => {
                    const blob = new Blob(du_lieu_am_thanh, { type: 'audio/webm' });
                    const r = new FileReader();
                    r.onload = e => {
                        DANH_SACH_TIN_NHAN.push({
                            uid: TAI_KHOAN_HIEN_TAI.uid,
                            userName: TAI_KHOAN_HIEN_TAI.name,
                            content: e.target.result,
                            type: 'voice'
                        });
                        localStorage.setItem('chat_data', JSON.stringify(DANH_SACH_TIN_NHAN));
                        VE_LAI_GIAO_DIEN();
                    };
                    r.readAsDataURL(blob);
                };
                b√¥_ghi_am.start();
                nut.classList.add('dang-ghi-am');
                nut.innerText = "üõë";
            }).catch(() => alert("L·ªói: Kh√¥ng t√¨m th·∫•y Microphone!"));
        } else {
            b√¥_ghi_am.stop();
            b√¥_ghi_am = null;
            nut.classList.remove('dang-ghi-am');
            nut.innerText = "üé§";
        }
    }

    /* --- KH·ªûI CH·∫†Y L·∫¶N ƒê·∫¶U --- */
    VE_LAI_GIAO_DIEN();
</script>
</body>
</html>
